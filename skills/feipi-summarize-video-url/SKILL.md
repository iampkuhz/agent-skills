---
name: feipi-summarize-video-url
description: 用于根据视频 URL 调用来源技能提取带时间戳文本，并生成两阶段远程总结请求包。在需要先交付结构化摘要、再补充背景与影响分析时使用。
---

# 视频 URL 文本总结技能（中文）

## 核心目标

输入视频 URL，输出用于远程大模型总结的两阶段请求包（提示词 + 字幕文本）。

1. 第一次交付（先返回用户）
- `摘要概述`：先总述，再用 1-2 级列表展开核心内容（仅保留视频时间锚点）。
- `附件`：给出原始视频跳转链接 + 本地转写文本路径。

2. 第二次交付（第一次后继续处理）
- `相关影响和背景分析`：补充背景知识与关键影响（背景为主、影响为辅）。

## 关键原则

1. 不做本地“伪摘要”
- 本 skill 只负责提取文本与构建请求包。
- 不在本地用词频/规则模板直接生成最终结论。

2. 摘要与时间线合并
- 不再单独输出“核心观点时间线”章节。
- 时间线信息必须并入 `摘要概述` 的列表锚点中（仅时间）。
- 时间格式统一：
  - 视频时长未超过 1 小时：`MM:SS`
  - 视频时长超过 1 小时：`HH:MM:SS`
  - 禁止 `T+00:00:00` 与字幕行号。

3. 总分结构强约束
- `摘要概述` 第一段必须是总述（先总后分）。
- 后续列表按关系选型：
  - 有先后/因果链：有序列表。
  - 关系并列：无序列表。
  - 存在总分关系：使用二级列表（最多二级）。

4. 去套话
- 请求包中显式禁用无意义模板句。
- 目标是直接提炼信息，不是点评文本写法。

5. 详略由模型读文本后决定
- 不依赖本地信息密度脚本。
- 仅按时长给建议条目区间，具体详略由远程模型判断。

6. 第二次交付必须可判定
- `相关影响和背景分析` 必须“背景知识为主（约 2/3）+ 关键影响为辅（约 1/3）”。
- 背景必须覆盖：`122 条款定义`、`历史使用场景`、`此前条款 -> 当前条款`、`已征税款处置路径`。
- 影响只写最关键 1-2 条，禁止冗长推演与空泛表述。

## 依赖技能（强约束）

必须依赖：
1. `skills/feipi-read-youtube-video`
2. `skills/feipi-read-bilibili-video`

规则：
- YouTube：调用 `feipi-read-youtube-video/scripts/download_youtube.sh`
- Bilibili：调用 `feipi-read-bilibili-video/scripts/download_bilibili.sh`
- 依赖缺失：立即停止并提示用户先配置。

## 输入与输出

1. 最少输入
- 视频 URL

2. 可选输入
- 视频标题
- 用户原始指令（用于自动判定提取质量档位）
- 质量档位参数：`--quality auto|fast|accurate`（默认 `auto`）

3. 输出
- `extract_video_text.sh` 会在 `output_dir` 下按 `source-url_key` 自动建子目录（如 `youtube-5Foo8VUZlFM`、`bilibili-BV1Q5fgBfExq`）。
- 子目录内包含本次 URL 的音频/字幕/转写与日志，避免多视频文件平铺。
- `summary_request.md`：第一次交付请求包（`摘要概述` + `附件`）。
- `background_request.md`：第二次交付请求包（`相关影响和背景分析`）。
- 远程模型第一次输出：`摘要概述` + `附件`。
- 远程模型第二次输出：`相关影响和背景分析`。

## 自动选档规则（提速重点）

1. 默认策略（`--quality auto`）
- 指令明确要求高质量（如“高质量/高精度/准确/逐字”）时，选择 `accurate`。
- 其他情况默认选择 `fast`。

2. `mode=auto` 的执行顺序
- `accurate`：先 `whisper`，失败再回退 `subtitle`。
- `fast`：先 `subtitle`，失败再回退 `whisper`。

3. 观测字段
- `extract_video_text.sh` 输出中包含：
  - `run_dir`
  - `whisper_profile`
  - `selection_reason`
  - `strategy`

## 工作流（Explore -> Plan -> Implement -> Verify）

1. Explore
- `scripts/extract_video_text.sh` 内部识别来源（YouTube/Bilibili）。
- `scripts/extract_video_text.sh --check-deps` 校验依赖与自动选档结果。

2. Plan
- 根据用户指令选择质量档位（默认快档，显式高质量则慢档）。
- `scripts/extract_video_text.sh` 获取带时间戳文本。
- 第一次交付：合并“摘要+时间线”，时间仅用 `MM:SS/HH:MM:SS`。
- 第二次交付：输出“背景知识补充（约 2/3）+ 关键影响（约 1/3）”，其中背景必须覆盖 `122 条款`、`历史使用`、`此前条款`、`税款处置`，避免重复第一次内容。

3. Implement
- 使用 `scripts/render_summary_prompt.sh` 生成第一次请求包（`summary_request.md`）。
- 将 `summary_request.md` 提交远程模型并先返回第一次结果给用户。
- 继续使用 `scripts/render_background_prompt.sh` 生成第二次请求包（`background_request.md`）。
- 将 `background_request.md` 提交远程模型，产出第二次结果再回复用户。

4. Verify
- 请求包包含 `<TRANSCRIPT_START>` 与 `<TRANSCRIPT_END>`。
- 第一次请求包包含反套话约束与列表结构约束。
- 第一次请求包要求锚点格式：`[MM:SS]` 或 `[HH:MM:SS]`。
- 第一次请求包明确禁止单独输出 `核心观点时间线` 章节。
- 第一次请求包明确“附件为原始视频链接 + 转写文本路径”。
- 第二次请求包明确要求输出 `相关影响和背景分析` 且不复述第一次内容。
- 第二次请求包明确要求“背景知识约 2/3 + 关键影响约 1/3”，并覆盖 `122 条款/历史使用/此前条款/税款处置`。

## 标准命令

1. 检查依赖：
```bash
bash scripts/extract_video_text.sh "<video_url>" "./tmp/video-text" auto \
  --instruction "请快速总结" \
  --check-deps
```

2. 自动选档提取（默认快档）：
```bash
bash scripts/extract_video_text.sh "<video_url>" "./tmp/video-text" auto \
  --instruction "请快速提取并总结重点"
```

3. 高质量提取（触发慢档）：
```bash
bash scripts/extract_video_text.sh "<video_url>" "./tmp/video-text" auto \
  --instruction "请高质量逐字转写，准确优先"
```

4. 显式指定档位（可绕过自动判定）：
```bash
bash scripts/extract_video_text.sh "<video_url>" "./tmp/video-text" whisper \
  --quality accurate
```

5. 生成第一次请求包：
```bash
bash scripts/render_summary_prompt.sh \
  "<video_url>" \
  "示例视频标题" \
  1500 \
  "./tmp/video-text/xxx.txt" \
  80000 \
  > "./tmp/video-text/summary_request.md"
```

6. 生成第二次请求包：
```bash
bash scripts/render_background_prompt.sh \
  "<video_url>" \
  "示例视频标题" \
  "./tmp/video-text/summary_result.md" \
  "./tmp/video-text/xxx.txt" \
  > "./tmp/video-text/background_request.md"
```

## 验收标准

1. 依赖缺失时失败退出。
2. 输出文本带时间戳。
3. 多 URL 场景下，文件按 `source-url_key` 子目录分组，不在根目录平铺。
4. 自动选档结果可观察（`run_dir`、`whisper_profile`、`selection_reason`、`strategy`）。
5. 第一次请求包包含字幕文本、反套话约束、总分结构约束、时间锚点约束（无行号）。
6. 第一次请求包要求输出 `摘要概述` 与 `附件`，且禁止单独“核心观点时间线”章节。
7. 第一次请求包中 `附件` 包含“原始视频链接 + 转写文本路径”。
8. 第二次请求包要求输出 `相关影响和背景分析`，且显式要求“背景优先、影响精简、新增信息”。

## 渐进式披露

- 来源：`references/sources.md`
